<% if @groups_excedeed %>
  <div class="reveal-overlay" style="display:inline" >
    <div id="myModal" class="large reveal warning callout" data-open="myModal" aria-labelledby="modalTitle"
         aria-hidden="true"  role="dialog" style="display: block; opacity: 1; top: 194px;">
      <h2 id="modalTitle">Exceso de efectivos asignados</h2>
      <p class="lead">Los efectivos asignados a los subprocesos superan los efectivos asignados a esta unidad para:
        <strong><%= @groups_excedeed %></strong></p>
      <% unless has_justification?(@unit.id, @period.id) %>
          <p> Si se trata de un <strong>error</strong> cierre la ventana, pulsando el aspa de la parte superior derecha y corriga los datos erróneos.</p>
          <p>Si no es un error y los efectivos que han participado en los procesos de la unidad son mayores a lo indicados
            en el cuadro <strong><em>EFECTIVOS UNIDAD</em></strong>, puede modificarlos, para adecuarlos a los que realmente han
            participado en estos procesos, pulsando en el botón <strong><em><%= t("entry_indicators.form.assigned_employees.update.button") %></em></strong>,
            lo que permitirá modificar los efectivos de la unidad y añadir una justificación a dicho cambios. Estos cambios
            quedarán pendientes de verificación por el resposable.</p>
          <a class="hollow button" onclick="closeModal()"> <%= t("entry_indicators.form.assigned_employees.update.button") %></a>
      <% else %>
          <button class="hollow button" onclick="openJustification()" aria-label="Close modal" type="button">
            <span aria-hidden="true"><%= t("entry_indicators.form.assigned_employees.close.button") %></span>
          </button>
      <% end %>
      <button class="close-button" onclick="closeModal()" aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="secondary callout reveal" id="justifyModal" >
      <h2><%= t("entry_indicators.form.assigned_employees.update.justification.title") %></h2>
      <button class="close-button" onclick="closeModal()" aria-label="Close reveal" type="button">
        <span aria-hidden="true">&times;</span>
      </button>

      <form name="justificationForm">
        <textarea name="justification" placeholder="<%= t("entry_indicators.form.assigned_employees.update.justification.label") %>" rows="4" ></textarea>
        <a class="hollow button" onclick="setJustification()"><%= t("entry_indicators.form.assigned_employees.update.button") %></a>
      </form>

      <script>
          function setJustification(){
              console.log("pasa por aqui")
              document.entryIndicatorsForm.justification.value=document.justificationForm.justification.value
              $("#justifyModal").hide()
              $(".reveal-overlay").hide()
          }

          function openJustification() {
            $("#myModal").hide()
            $("#justifyModal").show()
          }

          function closeModal() {
              $("#myModal").hide()
              $(".reveal-overlay").hide()
          }
      </script>
    </div>
  </div>
<% end %>

<div id="unit" class="unit text-center small-12 columns">
  <h3>
    <%= @unit.description_sap %>
  </h3>
</div>

<%= form_tag(updates_entry_indicators_path, method: 'post') do %>
  <div class="row">
    <% if @period.open_entry? %>
      <%= hidden_field_tag(:unit_id, @unit.id) %>
      <%= hidden_field_tag(:period_id, @period.id) %>
      <%= hidden_field_tag(:organization_id, @organization.id) %>
      <div class="small-12 medium-4 columns">
        <br>
        <%= submit_tag('Actualizar indicadores', class: 'button hollow large') %>
      </div>
    <% else %>
        <div class="small-12 medium-4 columns">  </div>
    <% end %>
    <div class="columns medium-4 small-12">
      <%= render 'staff', of: 'Unit', process: @unit, unit: @unit, period: @period, type: 'all' %>
    </div>
  </div>
  <% @period.main_processes.each do |main_process| %>
    <% if sub_processes_unit(main_process, @unit).count > 0 %>
      <div class="main_process small-12 columns">
        <h5><%= main_process.order%>.&nbsp;<%= main_process.item.description %></h5>
      </div>
      <% sub_processes_unit(main_process, @unit).each do |sub_process| %>
        <table class="indicator" >
          <caption class="sub_process"><%= main_process.order%>.<%= sub_process.order%>.&nbsp;<%= sub_process.item.description %></caption>
          <thead>
            <tr>
              <th><strong><%= t("entry_indicators.form.indicator.#{process_name(@period, 'indicators')}") %> </strong></th>
              <th><strong><%= t("entry_indicators.form.metric") %></strong></th>
              <th colspan="6"><strong><%= t("entry_indicators.form.source") %></strong></th>
              <%= render 'staff', of: 'Indicator', type: 'header' %>
              <th class="text-center amount"><strong><%= t('.amount') %></strong></th>
            </tr>
          </thead>
          <% sub_process.indicators.each do |indicator| %>
            <tr>
              <td colspan ="8" id="<%= "indicator_col_#{indicator.id}" %>">
                <% if indicator.description.nil? %>
                    <strong> <%= indicator.order %>. <%= indicator.item.description %></strong>
                <% else %>
                    <br>
                    <div class="moderation-description">
                      <%= simple_format (indicator.description) %>
                    </div>
                <% end %>
              </td>
                <%= render 'staff', of: 'Indicator', process: indicator, unit: @unit, period: @period, type: 'data' %>
            </tr>
            <tr>
              <% indicator.indicator_metrics.order(:id).each_with_index do |indicator_metric, index| %>
              <%= hidden_field_tag(:indicator_metric_id, indicator_metric.id) %>
              <td colspan = "1"></td>
              <td id="<%= "metric_col_#{indicator_metric.metric_id}" %>" ><%= get_metric(indicator_metric) %> </td>
              <td colspan ="11" id="<%= "source_col_#{source_id(indicator_metric)}" %>"> <%= sources_description(indicator_metric) %></td>
              <td id="<%= "indicator_metric_col_#{indicator_metric.id}" %>" class="text-center">
                <% amount_value = get_amount(indicator_metric, @unit) %>
                <% if @period.open_entry? %>
                  <%= text_field_tag("IndicatorMetric[#{indicator_metric.id}]", amount_value, class: 'inline amount', placeholder: t('.amount')) %>
                <% else %>
                  <%= amount_value %>
                <% end %>
              </td>
            </tr>
            <% end %>
          <% end %>

        </table>
        <div class="columns medium-offset-8 medium-4 small-12">
            <%= render 'staff', of: 'SubProcess', process: sub_process, unit: @unit, period: @period, type: 'all'   %>
        </div>
      <% end %>
    <% end %>
  <% end %>

  <% if @period.open_entry? %>
    <div class="small-12 medium-4 columns end">
      <br>
      <%= submit_tag('Actualizar indicadores', class: 'button hollow large') %>
    </div>
  <% end %>

<% end %>
